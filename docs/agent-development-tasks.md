# Agent 开发任务书

## 零、代码组织规范

### 0.1 代码修改原则 [最重要]
- 严格遵循最小修改原则
- 不得修改与当前任务无关的代码
- 禁止擅自优化或重构现有代码
- 如发现其他代码问题，记录后单独处理
- 保持现有代码的结构和风格
- 新增功能应该是独立的扩展，而不是修改

### 0.2 文件结构规范
- 每个功能模块使用独立目录
- 每个主要功能类独立成文件
- 工具函数放入独立的 utils 文件
- 类型定义放入独立的 types 文件
- 常量定义放入独立的 constants 文件

### 0.2 目录结构示例
```
src/renderer/
  ├── components/AIAssistant/
  │   └── modes/agent/              # Agent UI 组件（现有）
  │       ├── AgentMode.tsx        # 主组件
  │       ├── AgentMessage.tsx     # 消息组件
  │       ├── CommandConfirm.tsx   # 命令确认组件（新增）
  │       ├── ResultCard.tsx       # 结果展示组件（新增）
  │       ├── types.ts             # 组件类型定义（新增）
  │       └── index.tsx            # 导出文件
  └── services/modes/agent/         # Agent 服务目录（重构）
      ├── index.ts                 # 服务导出（从现有 agent.ts 迁移）
      ├── types.ts                 # 类型定义
      ├── constants.ts             # 常量定义
      ├── DialogueEngine.ts        # 对话引擎
      ├── TaskPlanner.ts           # 任务规划器
      ├── CommandGenerator.ts      # 命令生成器
      ├── ResultAnalyzer.ts        # 结果分析器
      └── utils/                   # 工具函数
          ├── prompt.ts            # 提示词工具
          ├── parser.ts            # 解析工具
          └── validator.ts         # 验证工具
```

### 0.3 代码组织原则
1. **职责单一**
   - 每个文件只负责一个功能模块
   - 每个类只负责一个主要功能
   - 每个方法只做一件事

2. **模块化**
   - 相关功能组织在同一目录
   - 公共功能抽取为独立模块
   - 避免循环依赖

3. **可维护性**
   - 清晰的文件命名
   - 完整的类型定义
   - 详细的注释说明

4. **可测试性**
   - 功能模块独立可测
   - 依赖注入便于 mock
   - 测试文件与源文件同目录

### 0.4 错误处理规范
- 所有错误必须有中文提示信息
- 错误信息需要包含错误码
- 错误需要分级处理（致命/警告/提示）
- 关键操作需要错误重试机制
- 用户友好的错误提示界面

### 0.5 日志记录规范
- 统一的日志格式
- 分级日志（DEBUG/INFO/WARN/ERROR）
- 关键操作必须记录日志
- 错误日志需要包含完整堆栈
- 敏感信息脱敏处理

### 0.6 代码提交规范
- 提交信息必须清晰描述改动
- 每次提交只做一件事
- 提交前进行代码格式化
- 确保所有测试通过
- 大功能使用功能分支开发

## 一、基础框架搭建

### 1.1 Agent 状态管理
- [x] 定义 Agent 状态
  * [x] IDLE: 空闲状态，等待新任务
  * [x] PLANNING: 规划任务步骤
  * [x] EXECUTING: 执行命令
  * [x] ANALYZING: 分析执行结果
  * [x] COMPLETED: 任务完成
  * [x] ERROR: 错误状态

### 1.2 Agent 自动化执行引擎
- [x] 实现状态机管理器
  * [x] 创建 AgentStateManager 类
    - [x] 管理状态转换
    - [x] 触发相应的处理函数
    - [x] 维护任务上下文
  * [x] 实现状态转换规则
    - [x] IDLE -> PLANNING: 接收新任务
    - [x] PLANNING -> EXECUTING: 生成命令
    - [x] EXECUTING -> ANALYZING: 命令执行完成
    - [x] ANALYZING -> PLANNING: 需要后续步骤
    - [x] ANALYZING -> COMPLETED: 任务完成
    - [x] 任意状态 -> ERROR: 发生错误
    - [x] ERROR -> PLANNING: 错误恢复

- [x] 实现自动化执行流程
  * [x] 创建 AgentExecutor 类
    - [x] 监听命令执行状态
    - [x] 自动获取执行结果
    - [x] 自动触发结果分析
    - [x] 自动执行下一步骤
  * [ ] 实现任务中断和恢复
    - [ ] 保存执行状态
    - [ ] 记录执行历史
    - [ ] 支持手动中断
    - [ ] 支持从断点恢复

### 1.5 多轮对话支持
- [x] 对话历史管理
  * [x] 实现对话历史存储
    - [x] 存储每轮对话的用户输入
    - [x] 存储每轮对话的执行结果
    - [x] 存储每轮对话的AI响应
    - [x] 限制历史记录大小(最多保留最近5轮)
  * [x] 优化消息传递格式
    - [x] 修改 messages 结构支持多轮对话
    - [x] 每轮对话带上上下文信息
    - [x] 压缩历史记录避免超出token限制

- [ ] UI 交互优化
  * [ ] 实现新消息框
    - [x] 每次提问都有对应的泡泡，跟对话一样（和命令模式那样）
    - [x] 显示用户输入时间
  * [ ] 消息分组展示
    - [ ] 按对话轮次分组
    - [ ] 展示对话主题
    - [ ] 支持折叠/展开历史对话
  * [ ] 历史记录导航
    - [ ] 添加对话跳转功能
    - [ ] 支持搜索历史对话
    - [ ] 支持标记重要对话

- [x] 上下文关联
  * [x] 实现对话关联
    - [x] 分析用户输入与历史的关联
    - [x] 自动关联相关的历史对话
    - [x] 支持手动关联历史对话
  * [x] 优化提示词
    - [x] 在 system prompt 中说明多轮对话规则
    - [x] 调整历史信息的展示格式
    - [x] 优化上下文关联的提示方式

- [ ] 性能优化
  * [ ] 消息存储优化
    - [ ] 实现消息分页加载
    - [ ] 优化历史记录存储结构
    - [ ] 添加消息缓存机制
  * [ ] 渲染性能优化
    - [ ] 实现消息懒加载
    - [ ] 优化消息更新机制
    - [ ] 添加虚拟滚动支持

## 二、核心功能实现

### 2.1 自动化执行引擎
- [ ] 实现命令执行监听
  * [ ] 监听 SSH 输出
    - [ ] 识别命令提示符
    - [ ] 检测执行完成
    - [ ] 捕获错误输出
  * [ ] 实现结果解析
    - [ ] 提取关键信息
    - [ ] 判断执行状态
    - [ ] 识别错误类型

- [ ] 实现自动化分析
  * [ ] 设计分析提示词
    - [ ] 包含任务目标
    - [ ] 包含执行历史
    - [ ] 包含当前输出
  * [ ] 实现结果处理
    - [ ] 解析 AI 响应
    - [ ] 提取下一步命令
    - [ ] 更新任务状态

### 2.2 错误处理机制
- [ ] 实现错误恢复
  * [ ] 常见错误处理
    - [ ] 权限错误
    - [ ] 网络错误
    - [ ] 超时错误
  * [ ] 自动重试机制
    - [ ] 设置重试策略
    - [ ] 记录重试历史
    - [ ] 防止无限重试

### 2.3 任务持久化
- [ ] 实现状态持久化
  * [ ] 保存任务信息
    - [ ] 任务目标
    - [ ] 执行历史
    - [ ] 当前状态
  * [ ] 实现状态恢复
    - [ ] 加载任务信息
    - [ ] 恢复执行状态
    - [ ] 继续执行任务

## 三、优化和测试

### 3.1 性能优化
- [ ] 优化响应速度
  * [ ] 减少 API 调用
  * [ ] 优化状态判断
  * [ ] 缓存中间结果

### 3.2 可靠性测试
- [ ] 编写测试用例
  * [ ] 状态转换测试
  * [ ] 错误恢复测试
  * [ ] 并发任务测试

### 3.3 结果展示
- [ ] 实现分析结果卡片
- [ ] 添加详情展开/收起
- [ ] 实现关键信息高亮
- [ ] 添加复制功能

## 四、优化和测试

### 4.1 性能优化
- [ ] 实现消息懒加载
- [ ] 添加状态缓存
- [ ] 优化渲染性能
- [ ] 添加防抖节流

### 4.2 异常处理
- [ ] 完善错误提示
- [ ] 添加重试机制
- [ ] 实现状态恢复
- [ ] 添加日志记录

### 4.3 测试用例
- [ ] 编写单元测试
- [ ] 添加集成测试
- [ ] 进行性能测试
- [ ] 执行安全测试

## 五、文档和部署

### 5.1 文档完善
- [ ] 更新 API 文档
- [ ] 编写使用说明
- [ ] 添加示例代码
- [ ] 完善注释

### 5.2 部署准备
- [ ] 检查依赖配置
- [ ] 优化构建脚本
- [ ] 准备部署文档
- [ ] 制定回滚方案 

### 1.5 多轮对话支持
- [x] 对话历史管理
  * [x] 实现对话历史存储
    - [x] 存储每轮对话的用户输入
    - [x] 存储每轮对话的执行结果
    - [x] 存储每轮对话的AI响应
    - [x] 限制历史记录大小(最多保留最近5轮)
  * [x] 优化消息传递格式
    - [x] 修改 messages 结构支持多轮对话
    - [x] 每轮对话带上上下文信息
    - [x] 压缩历史记录避免超出token限制

- [ ] UI 交互优化
  * [ ] 实现新消息框
    - [x] 每次提问都有对应的泡泡，跟对话一样（和命令模式那样）
    - [x] 显示用户输入时间
  * [ ] 消息分组展示
    - [ ] 按对话轮次分组
    - [ ] 展示对话主题
    - [ ] 支持折叠/展开历史对话
  * [ ] 历史记录导航
    - [ ] 添加对话跳转功能
    - [ ] 支持搜索历史对话
    - [ ] 支持标记重要对话

- [x] 上下文关联
  * [x] 实现对话关联
    - [x] 分析用户输入与历史的关联
    - [x] 自动关联相关的历史对话
    - [x] 支持手动关联历史对话
  * [x] 优化提示词
    - [x] 在 system prompt 中说明多轮对话规则
    - [x] 调整历史信息的展示格式
    - [x] 优化上下文关联的提示方式

- [ ] 性能优化
  * [ ] 消息存储优化
    - [ ] 实现消息分页加载
    - [ ] 优化历史记录存储结构
    - [ ] 添加消息缓存机制
  * [ ] 渲染性能优化
    - [ ] 实现消息懒加载
    - [ ] 优化消息更新机制
    - [ ] 添加虚拟滚动支持

- [ ] Agent模式 [设计文档: docs/agent-mode-ui-design.md]
    * [ ] 自动运行命令功能
      - [ ] 配置界面开发
        * [ ] 在模型配置页面增加 Agent 模式配置区域
          - [ ] 添加配置区域标题和说明
          - [ ] 使用卡片式布局展示配置项
        * [ ] 添加"开启自动分析"开关按钮
          - [ ] 使用 Switch 组件实现
          - [ ] 添加开关状态提示
          - [ ] 保存配置到本地存储
        * [ ] 添加命令风险等级选择
          - [ ] 使用 Radio.Group 组件
          - [ ] 选项：低风险/中风险/高风险
          - [ ] 每个选项添加帮助提示
          - [ ] 保存用户选择到本地存储
      - [ ] 自动执行流程
        * [ ] 获取大模型返回的命令风险等级
        * [ ] 根据用户配置的风险等级判断是否自动执行
          - [ ] 当命令风险等级 <= 用户配置的风险等级时自动执行
          - [ ] 当命令风险等级 > 用户配置的风险等级时不做任何操作

问题清单：
1.执行历史命令和结果太大导致ai无法正常回复
  1.1 执行历史做限制
  1.2 单次存储命令执行结果，采用先进先出，不要超过50行或者500字符
  1.3大模型回复的content为空的时候要显示进度状态为异常，不然一直停在思考中的状态