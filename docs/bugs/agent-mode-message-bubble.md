# Agent模式消息气泡显示问题

## 问题描述
1. AI回复会显示两次内容在一个回复泡泡里面，重复显示了。
2. 聊天框没有滚动条，多轮对话后不会往下滚。

## 问题分析
### 1. AI回复重复显示问题
在 `handleCommandExecuted` 方法中，每次执行命令后：
1. 添加命令输出到当前消息
2. 调用 `getNextStep` 获取 AI 的分析
3. 在 `getNextStep` 中重新构建完整的 prompt
4. 由于每次都用相同的输入构建 prompt，AI 会给出相同的分析结果

### 2. 滚动条问题
待分析...

## 修复方案
### 1. AI回复重复显示问题
修改 `handleCommandExecuted` 方法的逻辑：
1. 不要每次都调用 `getNextStep`
2. 只在命令执行完成且需要进一步分析时才调用
3. 在构建 prompt 时，只包含新的命令输出，而不是完整历史

### 2. 滚动条问题
待实现...

## 修复进度
- [ ] 修复 AI 回复重复显示问题
  - [ ] 修改 handleCommandExecuted 方法的执行逻辑
  - [ ] 优化 prompt 构建方式
- [ ] 修复滚动条问题

## 修改记录
### 2024-01-17
1. 分析了 AI 回复重复显示的根本原因：
   - 每次命令执行后都重新构建完整 prompt
   - 相同的输入导致 AI 给出相同的分析
2. 制定了新的修复方案：
   - 优化命令执行后的处理逻辑
   - 改进 prompt 构建方式 